<!DOCTYPE html>
<html lang="en" class=""> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Case Parser</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        .table-fixed-layout {
            table-layout: fixed;
        }
        .subject-column {
            word-break: break-word;
        }
        /* Custom scrollbar - Light Mode */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* slate-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* slate-500 */
        }

        /* Custom scrollbar - Dark Mode */
        .dark ::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 or similar dark */
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }

        .top-bar {
            /* background-color: #1a202c; /* Tailwind gray-900 for black-ish */
            background-color: #ffffff; /* White */
        }
        .dark .top-bar {
            background-color: #1e293b; /* slate-800 for dark mode */
        }

        .keyword-tag {
            background-color: #e2e8f0; /* slate-200 */
            color: #2d3748; /* slate-700 */
            padding: 0.25rem 0.75rem;
            border-radius: 9999px; /* pill shape */
            font-size: 0.875rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            display: inline-flex;
            align-items: center;
        }
        .dark .keyword-tag {
            background-color: #475569; /* slate-600 */
            color: #e2e8f0; /* slate-200 */
        }
        .keyword-tag button {
            margin-left: 0.5rem;
            color: #718096; /* slate-500 */
            background: none;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        .dark .keyword-tag button {
            color: #94a3b8; /* slate-400 */
        }
        .keyword-tag button:hover {
            color: #2d3748; /* slate-800 */
        }
        .dark .keyword-tag button:hover {
            color: #cbd5e1; /* slate-300 */
        }

        .action-button {
            background-color: #ffffff; /* white */
            color: #3b82f6; /* blue-500 */
            border: 1px solid #cbd5e1; /* slate-300 */
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .action-button:hover {
            background-color: #f8fafc; /* slate-50 */
            border-color: #94a3b8; /* slate-400 */
        }
        .dark .action-button {
            background-color: #334155; /* slate-700 */
            color: #60a5fa; /* blue-400 */
            border-color: #475569; /* slate-600 */
        }
        .dark .action-button:hover {
            background-color: #475569; /* slate-600 */
            border-color: #64748b; /* slate-500 */
        }
        
        .secondary-action-button { /* Styles made similar to primary as per request, can be differentiated if needed */
             background-color: #ffffff;
             color: #3b82f6; /* blue-500 */
             border: 1px solid #cbd5e1; /* slate-300 */
        }
        .secondary-action-button:hover {
             background-color: #f8fafc; /* slate-50 */
             border-color: #94a3b8; /* slate-400 */
        }
         .dark .secondary-action-button {
            background-color: #334155; /* slate-700 */
            color: #60a5fa; /* blue-400 */
            border-color: #475569; /* slate-600 */
        }
        .dark .secondary-action-button:hover {
            background-color: #475569; /* slate-600 */
            border-color: #64748b; /* slate-500 */
        }


        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2d3748; /* slate-800 */
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            visibility: hidden;
        }
        .dark .toast {
            background-color: #e2e8f0; /* slate-200 */
            color: #1e293b; /* slate-800 */
        }
        .toast.show {
            opacity: 1;
            visibility: visible;
        }
        /* Ensure Tailwind dark mode works with class strategy */
        :root {
            --tw-bg-opacity: 1;
        }
    </style>
    <script>
        // Tailwind dark mode setup
        // On page load or when changing themes, best to add inline in `head` to avoid FOUC
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark')
        } else {
          document.documentElement.classList.remove('dark')
        }
    </script>
</head>
<body class="bg-slate-100 dark:bg-slate-900 min-h-screen flex flex-col items-center">

    <div class="top-bar w-full py-3 px-4 md:px-8 shadow-md flex justify-between items-center">
        <h1 class="text-2xl font-bold text-slate-800 dark:text-white">Amazon Case Parser</h1>
        <button id="darkModeToggle" class="p-2 rounded-md text-sm font-medium 
                                           text-slate-700 hover:bg-slate-200 
                                           dark:text-slate-300 dark:hover:bg-slate-700">
            Toggle Dark Mode
        </button>
    </div>

    <div class="bg-white dark:bg-slate-800 w-full max-w-5xl rounded-xl shadow-2xl p-6 md:p-8 space-y-6 mt-8 mb-8">
        <section class="space-y-4">
            <div>
                <label for="rawData" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Paste Case Data:</label>
                <textarea id="rawData" rows="10" class="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow bg-white dark:bg-slate-700 dark:text-slate-200 dark:placeholder-slate-400" placeholder="Paste the entire text from the 'Your Cases and Requests' page here..."></textarea>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="addKeywordInput" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Add Auto-filter Subject Keyword:</label>
                    <div class="flex">
                        <input type="text" id="addKeywordInput" class="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-l-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow bg-white dark:bg-slate-700 dark:text-slate-200 dark:placeholder-slate-400" placeholder="Enter keyword">
                        <button id="addKeywordButton" class="action-button rounded-l-none rounded-r-lg px-4">Add</button>
                    </div>
                    <div id="keywordsList" class="mt-2">
                        </div>
                </div>
                <div>
                    <label for="filterSubjectDropdown" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Filter by Subject:</label>
                    <select id="filterSubjectDropdown" class="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow bg-white dark:bg-slate-700 dark:text-slate-200">
                        <option value="">All Subjects</option>
                        </select>
                </div>
            </div>
        </section>

        <section class="space-y-3 md:space-y-0 md:flex md:flex-wrap md:items-center md:justify-start md:gap-4 py-2">
            <button id="copyDisplayedIdsButton" class="action-button w-full md:w-auto mb-2 md:mb-0">Copy Displayed IDs</button>
            <button id="openAllDisplayedIdsButton" class="action-button secondary-action-button w-full md:w-auto mb-2 md:mb-0">Open All Displayed IDs</button>
            <div class="flex items-center w-full md:w-auto">
                <input type="checkbox" id="enableHyperlinksCheckbox" class="h-4 w-4 text-blue-600 border-slate-300 dark:border-slate-600 rounded focus:ring-blue-500 bg-white dark:bg-slate-700 dark:focus:ring-offset-slate-800">
                <label for="enableHyperlinksCheckbox" class="ml-2 block text-sm text-slate-700 dark:text-slate-300">Enable Case ID Hyperlinks</label>
            </div>
        </section>


        <section class="space-y-4">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <h2 class="text-xl font-semibold text-slate-700 dark:text-slate-200">Parsed Cases</h2>
                <input type="text" id="searchTable" class="w-full sm:w-1/2 lg:w-1/3 p-3 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow bg-white dark:bg-slate-700 dark:text-slate-200 dark:placeholder-slate-400" placeholder="Search subjects or Case IDs...">
            </div>
            
            <div class="overflow-x-auto bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 shadow">
                <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700 table-fixed-layout">
                    <thead class="bg-slate-50 dark:bg-slate-700">
                        <tr>
                            <th scope="col" class="w-1/4 px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Case ID</th>
                            <th scope="col" class="w-3/4 px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider subject-column">Subject</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                        <tr><td colspan="2" class="px-4 py-10 text-center text-slate-500 dark:text-slate-400">Paste data to see results.</td></tr>
                    </tbody>
                </table>
            </div>
            <p id="rowCount" class="text-sm text-slate-500 dark:text-slate-400 text-right"></p>
        </section>

        <footer class="text-center text-xs text-slate-400 dark:text-slate-500 pt-4 border-t border-slate-200 dark:border-slate-700">
            Offline Tool &copy; 2025
        </footer>
    </div>
    <div id="toastNotification" class="toast"></div>

    <script>
        const rawDataInput = document.getElementById('rawData');
        const addKeywordInput = document.getElementById('addKeywordInput');
        const addKeywordButton = document.getElementById('addKeywordButton');
        const keywordsListDiv = document.getElementById('keywordsList');
        const filterSubjectDropdown = document.getElementById('filterSubjectDropdown');
        const searchTableInput = document.getElementById('searchTable');
        const resultsTableBody = document.getElementById('resultsTableBody');
        const rowCountDisplay = document.getElementById('rowCount');
        const copyDisplayedIdsButton = document.getElementById('copyDisplayedIdsButton');
        const enableHyperlinksCheckbox = document.getElementById('enableHyperlinksCheckbox');
        const openAllDisplayedIdsButton = document.getElementById('openAllDisplayedIdsButton');
        const toastNotification = document.getElementById('toastNotification');
        const darkModeToggleButton = document.getElementById('darkModeToggle');

        let allParsedData = []; 
        let autoFilterKeywords = [];
        const CASE_URL_PREFIX = "https://sellercentral.amazon.com/cu/case-dashboard/view-case?ref=sc_cd_lobby_vc_v3&ie=UTF&caseID=";

        // Dark Mode Logic
        function setDarkMode(isDark) {
            if (isDark) {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
                darkModeToggleButton.textContent = 'Toggle Light Mode';
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
                darkModeToggleButton.textContent = 'Toggle Dark Mode';
            }
        }

        darkModeToggleButton.addEventListener('click', () => {
            setDarkMode(!document.documentElement.classList.contains('dark'));
        });

        // Initialize dark mode toggle button text
        if (document.documentElement.classList.contains('dark')) {
             darkModeToggleButton.textContent = 'Toggle Light Mode';
        } else {
             darkModeToggleButton.textContent = 'Toggle Dark Mode';
        }


        function showToast(message) {
            toastNotification.textContent = message;
            toastNotification.classList.add('show');
            setTimeout(() => {
                toastNotification.classList.remove('show');
            }, 3000);
        }

        function renderKeywords() {
            keywordsListDiv.innerHTML = '';
            autoFilterKeywords.forEach((keyword, index) => {
                const tag = document.createElement('span');
                tag.className = 'keyword-tag'; // CSS will handle dark mode for this class
                tag.textContent = keyword;
                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = '&times;';
                deleteButton.onclick = () => {
                    autoFilterKeywords.splice(index, 1);
                    renderKeywords();
                    parseAndDisplayData(); 
                };
                tag.appendChild(deleteButton);
                keywordsListDiv.appendChild(tag);
            });
        }

        addKeywordButton.addEventListener('click', () => {
            const keyword = addKeywordInput.value.trim();
            if (keyword && !autoFilterKeywords.includes(keyword.toLowerCase())) {
                autoFilterKeywords.push(keyword.toLowerCase());
                renderKeywords();
                parseAndDisplayData(); 
                addKeywordInput.value = '';
            } else if (autoFilterKeywords.includes(keyword.toLowerCase())) {
                showToast("Keyword already added.");
            }
        });
        addKeywordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addKeywordButton.click();
            }
        });


        function populateSubjectDropdown() {
            const uniqueSubjects = [...new Set(allParsedData.map(item => item.subject.trim()).filter(s => s))].sort();
            const currentVal = filterSubjectDropdown.value;
            filterSubjectDropdown.innerHTML = '<option value="">All Subjects</option>'; // Reset
            uniqueSubjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                filterSubjectDropdown.appendChild(option);
            });
            filterSubjectDropdown.value = currentVal; // try to preserve selection
        }

        function parseAndDisplayData() {
            const rawText = rawDataInput.value;
            allParsedData = []; 

            if (!rawText.trim()) {
                filterTableForDisplay(); 
                populateSubjectDropdown(); 
                return;
            }

            const records = rawText.split(/\n\s*View(?:\s*\n|\s*$)/);
            
            records.forEach(recordText => {
                const trimmedRecord = recordText.trim();
                if (!trimmedRecord) return;

                const idMatch = trimmedRecord.match(/GMT\+\d{1,2}\s*(\d+)/);
                const caseId = idMatch ? idMatch[1] : null;
                if (!caseId) return;
                
                const emailAndSubjectRegex = /[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}\s*(?:\t|\n)*(.*)/s;
                const subjectMatch = trimmedRecord.match(emailAndSubjectRegex);
                let subject = (subjectMatch && subjectMatch[1]) ? subjectMatch[1].trim() : "";
                
                if (autoFilterKeywords.length > 0) {
                    const subjectLower = subject.toLowerCase();
                    if (!autoFilterKeywords.some(k => subjectLower.includes(k))) {
                        return; 
                    }
                }
                allParsedData.push({ id: caseId, subject: subject });
            });
            
            allParsedData.sort((a, b) => b.id.localeCompare(a.id)); // Sort by Case ID descending initially
            populateSubjectDropdown();
            filterTableForDisplay(); 
        }

        function filterTableForDisplay() {
            const searchTerm = searchTableInput.value.trim().toLowerCase();
            const selectedSubject = filterSubjectDropdown.value;
            let dataToDisplay = allParsedData;

            if (selectedSubject) {
                dataToDisplay = dataToDisplay.filter(item => item.subject === selectedSubject);
            }

            if (searchTerm) {
                dataToDisplay = dataToDisplay.filter(item => 
                    item.subject.toLowerCase().includes(searchTerm) ||
                    item.id.toLowerCase().includes(searchTerm)
                );
            }
            renderTable(dataToDisplay);
        }

        function renderTable(data) {
            resultsTableBody.innerHTML = ''; 
            const hyperlinksEnabled = enableHyperlinksCheckbox.checked;

            if (data.length === 0) {
                const tr = document.createElement('tr');
                let message = 'Paste data above to see results.';
                if (rawDataInput.value.trim() || autoFilterKeywords.length > 0 || filterSubjectDropdown.value || searchTableInput.value.trim()) {
                     message = 'No cases match your current filters/search.';
                }
                tr.innerHTML = `<td colspan="2" class="px-4 py-10 text-center text-slate-500 dark:text-slate-400">${message}</td>`;
                resultsTableBody.appendChild(tr);
            } else {
                 data.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.classList.add('hover:bg-slate-50', 'dark:hover:bg-slate-700', 'transition-colors');
                    
                    const tdId = document.createElement('td');
                    tdId.className = 'px-4 py-3 whitespace-nowrap text-sm text-slate-700 dark:text-slate-300';
                    if (hyperlinksEnabled) {
                        const link = document.createElement('a');
                        link.href = CASE_URL_PREFIX + item.id;
                        link.textContent = item.id;
                        link.target = "_blank";
                        link.classList.add('text-blue-600', 'dark:text-blue-400', 'hover:text-blue-800', 'dark:hover:text-blue-300', 'hover:underline');
                        tdId.appendChild(link);
                    } else {
                        tdId.textContent = item.id;
                    }
                    
                    const tdSubject = document.createElement('td');
                    tdSubject.className = 'px-4 py-3 text-sm text-slate-700 dark:text-slate-300 subject-column';
                    tdSubject.textContent = item.subject;
                    
                    tr.appendChild(tdId);
                    tr.appendChild(tdSubject);
                    resultsTableBody.appendChild(tr);
                });
            }
            updateRowCount(data.length, allParsedData.length);
        }
        
        function updateRowCount(displayedCount, totalParsedCount) {
            if (!rawDataInput.value.trim() && totalParsedCount === 0) {
                 rowCountDisplay.textContent = '';
                 return;
            }

            let baseTotalForMessage = allParsedData.length; // Total after autoFilterKeywords and before subject/searchbox filter

            // If subject dropdown is active, the "of X" should be based on that filtered subset
            if (filterSubjectDropdown.value) {
                baseTotalForMessage = allParsedData.filter(item => item.subject === filterSubjectDropdown.value).length;
            }
            
            if (searchTableInput.value.trim() && displayedCount !== baseTotalForMessage) {
                 rowCountDisplay.textContent = `Displaying ${displayedCount} of ${baseTotalForMessage} cases. (Total unique parsed: ${allParsedData.length})`;
            } else if (displayedCount !== allParsedData.length && (autoFilterKeywords.length > 0 || filterSubjectDropdown.value)) {
                 rowCountDisplay.textContent = `Displaying ${displayedCount} of ${allParsedData.length} cases.`;
            }
            else {
                 rowCountDisplay.textContent = `Displaying ${displayedCount} cases.`;
            }
        }
        
        copyDisplayedIdsButton.addEventListener('click', () => {
            const idsToCopy = [];
            const rows = resultsTableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const idCell = row.querySelector('td:first-child');
                if (idCell) {
                    const link = idCell.querySelector('a');
                    if (link) {
                        idsToCopy.push(link.textContent);
                    } else {
                        idsToCopy.push(idCell.textContent);
                    }
                }
            });

            if (idsToCopy.length > 0) {
                const textToCopy = idsToCopy.join('\n');
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                textArea.style.position = "fixed"; 
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast(`${idsToCopy.length} Case ID(s) copied to clipboard!`);
                } catch (err) {
                    showToast('Failed to copy Case IDs.');
                    console.error('Fallback: Oops, unable to copy', err);
                }
                document.body.removeChild(textArea);
            } else {
                showToast('No Case IDs to copy.');
            }
        });

        enableHyperlinksCheckbox.addEventListener('change', () => {
            filterTableForDisplay(); 
        });

        openAllDisplayedIdsButton.addEventListener('click', () => {
            if (!enableHyperlinksCheckbox.checked) {
                showToast("Please enable Case ID hyperlinks first.");
                return;
            }
            const linksToOpen = [];
            const rows = resultsTableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const idLink = row.querySelector('td:first-child a'); 
                if (idLink && idLink.href) {
                    linksToOpen.push(idLink.href);
                }
            });

            if (linksToOpen.length > 0) {
                let count = 0;
                linksToOpen.forEach((url, index) => {
                    setTimeout(() => {
                        const newTab = window.open(url, '_blank');
                        if (newTab) {
                            count++;
                        }
                        if (index === linksToOpen.length - 1) { // Check on the last attempt
                             if (count > 0) {
                                showToast(`Attempted to open ${count} case(s). Check browser pop-up settings if some didn't open.`);
                            } else if (linksToOpen.length > 0) { // If attempted but all failed
                                showToast(`Could not open cases. Please check your browser's pop-up blocker settings.`);
                            }
                        }
                    }, index * 150); // Slightly increased delay
                });
                 if (linksToOpen.length === 0 && displayedData.length > 0 ) { // Typo, should be current displayed data
                     showToast("No hyperlinked Case IDs currently displayed to open.");
                 }
            } else {
                showToast('No displayed Case IDs to open.');
            }
        });


        // Event Listeners
        rawDataInput.addEventListener('input', parseAndDisplayData);
        filterSubjectDropdown.addEventListener('change', filterTableForDisplay);
        searchTableInput.addEventListener('input', filterTableForDisplay);

        // Initial call
        parseAndDisplayData();
        renderKeywords();

    </script>
</body>
</html>
